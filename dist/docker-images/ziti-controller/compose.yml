
volumes:
  ziti-controller:
    driver: local

services:
  chown-volume:
    image: busybox
    command: chown -R ${ZIGGY_UID:-2171} /mnt
    volumes:
      - ziti-controller:/mnt

  ziti-controller:
    image: ${ZITI_CONTROLLER_IMAGE:-openziti/ziti-controller}
    depends_on:
      chown-volume:
        condition: service_completed_successfully
    volumes:
      - ziti-controller:/mnt
    working_dir: /mnt
    # these declared vars pass through to container and should be assigned in an .env file or exported from parent env
    # to ensure consistency throughout the compose project
    environment:
      # *** these are the important vars to set ***
      ZITI_CTRL_ADVERTISED_ADDRESS:                                   # domain name of this controller (required)
      ZITI_CTRL_ADVERTISED_PORT: ${ZITI_CTRL_ADVERTISED_PORT:-1280}   # exposed port of this controller
      ZITI_PWD: ${ZITI_PWD:-}                                         # password for the default admin user

      # *** less relevant vars below ***
      ZITI_BOOTSTRAP_PKI: true
      ZITI_BOOTSTRAP_CONFIG: true      # make config file from env vars and defaults if "true," overwrite if "force"
      ZITI_BOOTSTRAP_DATABASE: true    # make the default admin user if "true"
      ZITI_AUTO_RENEW_CERTS: true      # renew certs automatically every startup
    command: run config.yml
    ports:
      # ensure this port matches the value of ZITI_CTRL_PORT in the container
      - ${ZITI_INTERFACE:-0.0.0.0}:${ZITI_CTRL_ADVERTISED_PORT:-1280}:${ZITI_CTRL_ADVERTISED_PORT:-1280}
    expose:
      - ${ZITI_CTRL_ADVERTISED_PORT:-1280}
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - ziti
        - agent
        - stats
      interval: 3s
      timeout: 3s
      retries: 5
      start_period: 15s
